# MongoDB

MongoDB is a NoSQL database that we use to store our data. It is a document-oriented database that stores data in JSON-like documents with dynamic schemas.
You can access the documentation [here](https://docs.mongodb.com/).
You can connect to the database using MongoDBCompass or any other MongoDB client.

We manage the database in the `./db` folder

Inside this folder we find : 

- DB_Collections folder
- DB_Insert folder
- compile_db_script.sh
- [Dockerfile](docker.md#mongodb-dockerfile)
- init_database.js
- mongod.conf

## DB_Collections

MongoDB allow us to create Collections (equivalent to table in SQL)
Those collections can be set with a validator so that to CREATE/UPDATE a element of the collection it has to be validate by the validator otherwise it will throw an error.

Therefor we can define the structure of our database and make sure that it will not be corrupted by a bad input. Just like a SQL database. We can define the type of each field and wich field are required or not.

In the DB_Collections folder we find all the collections of our database.
Here is an example of a collection with the User Object :

```js title="/db/DB_Collections/user.js"
// Collection: user
db.createCollection("users", {
    validator: {
        $jsonSchema: {
            bsonType: "object",
            required: ["login", "firstName", "lastName"],
            properties: {
                login: {
                    bsonType: "string",
                    description: "must be a string and is required"
                },
                firstName: {
                    bsonType: "string",
                    description: "must be a string and is required"
                },
                lastName: {
                    bsonType: "string",
                    description: "must be a string and is required"
                }
            }
        }
    }
});
```

## DB_Insert
The DB_Insert folder contains all the insertions of our database.
It is mostly used for debugging purpose but in our context it will serve as a way to add the Readiness Levels from the KTH specifications.

Again here is an example of the User Object Insertion :

```js title="/db/DB_Insert/user.js"
// Insert : Users
const users = db.users.insertMany([
    {
        "login":"admin",
        "firstName":"admin",
        "lastName":"admin"
    },
    {
        "login":"cardotcl",
        "firstName":"ClÃ©ment",
        "lastName":"Cardot"
    },
    ...
    {
        "login":"jeanm",
        "firstName":"Marie",
        "lastName":"Jean"
    }
]);
```

## init_database.js
This very small script is used to initialize the main database script that will be generated by the next script.

```js title="/db/init_database.js"
// Define the Database
db = new Mongo().getDB("xrlonline");
```

## compile_db_script.sh

As you may have noticed, the collections and insertions are separated in different files. This is because it's easier to maintain and to read and to version with git. But MongoDB need a single file to initialize the database. That is why we have created this script that will concatenate all the files into a single one.

```sh title="/db/compile_db_script.sh"
cat init_database.js > mongo-init.js
cat DB_Collections/user.js >> mongo-init.js
cat DB_Collections/team.js >> mongo-init.js
cat DB_Collections/business_line.js >> mongo-init.js
cat DB_Collections/readiness_level.js >> mongo-init.js
cat DB_Collections/project.js >> mongo-init.js
cat DB_Insert/user.js >> mongo-init.js
cat DB_Insert/team.js >> mongo-init.js
cat DB_Insert/business_line.js >> mongo-init.js
cat DB_Insert/readiness_level.js >> mongo-init.js
cat DB_Insert/project.js >> mongo-init.js
```

## mongod.conf
This file is used to configure the MongoDB server. The only thing we changed is the bindIp to allow the server to be accessible from outside the container. For security reason, it could be interesting to remove this line and avoid anyone to access the database from outside the container.

```conf title="/db/mongod.conf"
# mongod.conf

# for documentation of all options, see:
#   http://docs.mongodb.org/manual/reference/configuration-options/

# Where and how to store data.
storage:
  dbPath: /var/lib/mongodb

# where to write logging data.
systemLog:
  destination: file
  logAppend: true
  path: /var/log/mongodb/mongod.log

# network interfaces
net:
  port: 27017
  bindIp: 0.0.0.0


# how the process runs
processManagement:
  timeZoneInfo: /usr/share/zoneinfo
```